<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²¡í„°ìŠ¤í† ì–´ ë§Œë“¤ê¸°</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/file_upload.css">
    <link rel="stylesheet" href="/css/file_rag.css">
    <link rel="stylesheet" href="/css/vectorstore.css">
</head>
<body>
    <div class="page-wrapper">
        <div class="page-header">
            <div class="title-container">
                <h1>ë²¡í„°ìŠ¤í† ì–´ ë§Œë“¤ê¸°</h1>
                <a href="/file_manager" class="back-link-small">íŒŒì¼ê´€ë¦¬í”„ë¡œê·¸ë¨ ë°”ë¡œê°€ê¸°</a>
            </div>
        </div>
        
        <!-- ê¸°ëŠ¥ ì„ íƒ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="content-card">
            <h2>ê¸°ëŠ¥ ì„ íƒ</h2>
            <div class="button-container">
                <a href="/file_upload" class="upload-link">íŒŒì¼ì—…ë¡œë“œ</a>
                <a href="/folder_upload" class="folder-link">í´ë” ì—…ë¡œë“œ</a>
                <a href="/vectorstore" class="vector-link">ë²¡í„°ìŠ¤í† ì–´ ë§Œë“¤ê¸°</a>
                <a href="/file_search" class="search-link">ë¬¸ì„œë‚´ìš© ê²€ìƒ‰íŒŒì¼</a>
            </div>
        </div>
        
        <div class="content-card">
            <h2>DBì— ì €ì¥ëœ ë‚´ìš© ë²¡í† ìŠ¤í† ì–´ ìƒì„±</h2>
            <button id="createVectorStoreBtn" class="upload-btn" style="margin-top: 20px;">ë²¡í„° ìŠ¤í† ì–´ ìƒì„±</button>
            <div id="resultMessage" style="margin-top: 20px;"></div>
        </div>

        <div class="content-card">
            <h2>ìƒì„±ëœ ë²¡í„°ìŠ¤í† ì–´ ëª©ë¡</h2>
            <div id="vectorstoreList" class="vectorstore-list">
                <table class="vectorstore-table">
                    <thead>
                        <tr>
                            <th style="width: 150px;">ìˆœë²ˆ</th>
                            <th>í´ë”ëª…</th>
                            <th>ë¬¸ì„œìˆ˜ëŸ‰</th>
                            <th>ìƒì„±ë‚ ì§œ</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="vectorstoreTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-muted);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì§„í–‰ ëª¨ë‹¬ -->
    <div id="progressModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘...</h3>
            <div id="progressStatus" style="margin: 20px 0;">
                <p id="statusText">ì´ˆê¸°í™” ì¤‘...</p>
            </div>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="finalResult" style="margin-top: 20px; display: none;">
                <p id="resultText" style="font-size: 18px; font-weight: bold;"></p>
            </div>
            <button id="closeModalBtn" class="upload-btn" style="margin-top: 20px; display: none;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const createVectorStoreBtn = document.getElementById('createVectorStoreBtn');
        const progressModal = document.getElementById('progressModal');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const finalResult = document.getElementById('finalResult');
        const resultText = document.getElementById('resultText');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const resultMessage = document.getElementById('resultMessage');
        const vectorstoreTableBody = document.getElementById('vectorstoreTableBody');

        // ë²¡í„°ìŠ¤í† ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadVectorStoreList() {
            try {
                const response = await fetch('/api/vectorstore-list');
                const data = await response.json();
                
                if (data.success && data.folders.length > 0) {
                    // ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    window.vectorstoreData = data.folders;
                    
                    const rowsHTML = data.folders.map((folder, index) => {
                        const displayId = index === 0 
                            ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">ìµœì‹ </span>`
                            : folder.id;
                        
                        // ì²« ë²ˆì§¸ í–‰(ìµœì‹ )ì€ ìš´ì˜ì¤‘ ë²„íŠ¼, ë‚˜ë¨¸ì§€ëŠ” ì‚­ì œ ë²„íŠ¼
                        const buttonHtml = index === 0
                            ? `<button onclick="alert('í˜„ì¬ ìš´ì˜ì¤‘ì¸ ë²¡í„°ìŠ¤í† ì–´ ì…ë‹ˆë‹¤.'); return false;" style="padding: 8px 16px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 4px rgba(17, 153, 142, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(17, 153, 142, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(17, 153, 142, 0.3)';">
                                    âœ… ìš´ì˜ì¤‘
                                </button>`
                            : `<button onclick="deleteVectorStore(${folder.id})" style="padding: 8px 16px; background: #f5576c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#e0485c'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='#f5576c'; this.style.transform='translateY(0)';">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>`;
                        
                        return `
                        <tr data-index="${index}" data-folder-id="${folder.id}">
                            <td style="text-align: center; font-weight: 600; color: var(--primary-color);">${displayId}</td>
                            <td>${folder.name}</td>
                            <td>${folder.fileCount}ê°œ</td>
                            <td>${folder.date}</td>
                            <td style="text-align: center;">
                                ${buttonHtml}
                            </td>
                        </tr>
                        `;
                    }).join('');
                    vectorstoreTableBody.innerHTML = rowsHTML;
                    
                    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    vectorstoreTableBody.querySelectorAll('tr').forEach(row => {
                        row.addEventListener('click', function(e) {
                            // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” í–‰ ì„ íƒ ë™ì‘ ì•ˆ í•¨
                            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                                return;
                            }
                            
                            // ì´ì „ ì„ íƒ ì œê±°
                            vectorstoreTableBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                            // í˜„ì¬ í–‰ ì„ íƒ
                            this.classList.add('selected');
                        });
                    });
                    
                    // ì²« ë²ˆì§¸ í–‰(ìµœì‹ ) ìë™ ì„ íƒ
                    const firstRow = vectorstoreTableBody.querySelector('tr');
                    if (firstRow) {
                        firstRow.classList.add('selected');
                    }
                } else {
                    vectorstoreTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">ìƒì„±ëœ ë²¡í„°ìŠ¤í† ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading vectorstore list:', error);
                vectorstoreTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // ë²¡í„°ìŠ¤í† ì–´ ì‚­ì œ í•¨ìˆ˜ (ì „ì—­ìœ¼ë¡œ ë“±ë¡)
        window.deleteVectorStore = async function(folderId) {
            const folderName = window.vectorstoreData?.find(f => f.id === folderId)?.name || '';
            
            // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
            const confirmed = confirm(`ì •ë§ë¡œ "${folderName}" ë²¡í„°ìŠ¤í† ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-vectorstore/${folderId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ë²¡í„°ìŠ¤í† ì–´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadVectorStoreList();
                } else {
                    alert('âŒ ë²¡í„°ìŠ¤í† ì–´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ë²¡í„°ìŠ¤í† ì–´ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadVectorStoreList();

        // ì§„í–‰ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            statusText.textContent = text;
        }

        // Python ì¶œë ¥ íŒŒì‹±í•˜ì—¬ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function parseProgress(output) {
            const lines = output.split('\n');
            
            for (let line of lines) {
                if (line.includes('MySQL ì—°ê²° ì„±ê³µ')) {
                    updateProgress(10, 'MySQL ì—°ê²° ì„±ê³µ');
                } else if (line.includes('ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ')) {
                    // ë¬¸ì„œ ê°œìˆ˜ ì¶”ì¶œ
                    const match = line.match(/(\d+)ê°œ ë¬¸ì„œ/);
                    if (match) {
                        updateProgress(25, `${match[1]}ê°œ ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ`);
                    }
                } else if (line.includes('ì²­í‚¹ ì™„ë£Œ')) {
                    updateProgress(40, 'ë¬¸ì„œ ì²­í‚¹ ì™„ë£Œ');
                } else if (line.includes('ì„ë² ë”© ëª¨ë¸ ì„¤ì • ì™„ë£Œ')) {
                    updateProgress(60, 'ì„ë² ë”© ëª¨ë¸ ì„¤ì • ì™„ë£Œ');
                } else if (line.includes('ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘')) {
                    updateProgress(80, 'ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘...');
                } else if (line.includes('ë²¡í„°ìŠ¤í† ì–´ êµ¬ì¶• ì™„ë£Œ')) {
                    updateProgress(100, 'ì™„ë£Œ!');
                }
            }
        }

        // ë¬¸ì„œ ê°œìˆ˜ ì¶”ì¶œ
        function extractDocumentCount(output) {
            const match = output.match(/MySQLì—ì„œ (\d+)ê°œ ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ/);
            return match ? match[1] : null;
        }

        // ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        createVectorStoreBtn.addEventListener('click', async () => {
            // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
            const confirmed = confirm('ë²¡í„°ìŠ¤í† ì–´ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!confirmed) {
                return;
            }

            // ëª¨ë‹¬ ì—´ê¸°
            progressModal.style.display = 'block';
            statusText.textContent = 'ë²¡í„°ìŠ¤í† ì–´ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            finalResult.style.display = 'none';
            closeModalBtn.style.display = 'none';
            createVectorStoreBtn.disabled = true;

            try {
                // API í˜¸ì¶œ
                const response = await fetch('/api/create-vectorstore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // ì§„í–‰ë°” ì—…ë°ì´íŠ¸
                    parseProgress(data.output || '');
                    
                    // ì™„ë£Œ ë©”ì‹œì§€
                    setTimeout(() => {
                        const docCount = extractDocumentCount(data.output || '');
                        if (docCount) {
                            finalResult.style.display = 'block';
                            resultText.textContent = `âœ… ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ! (${docCount}ê°œ ë¬¸ì„œ)`;
                            resultText.style.color = 'green';
                        } else {
                            finalResult.style.display = 'block';
                            resultText.textContent = 'âœ… ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ!';
                            resultText.style.color = 'green';
                        }
                        closeModalBtn.style.display = 'block';
                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadVectorStoreList();
                    }, 500);
                } else {
                    updateProgress(0, 'ì˜¤ë¥˜ ë°œìƒ');
                    finalResult.style.display = 'block';
                    resultText.textContent = 'âŒ ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì‹¤íŒ¨';
                    resultText.style.color = 'red';
                    closeModalBtn.style.display = 'block';
                }
            } catch (error) {
                updateProgress(0, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                finalResult.style.display = 'block';
                resultText.textContent = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message;
                resultText.style.color = 'red';
                closeModalBtn.style.display = 'block';
            } finally {
                createVectorStoreBtn.disabled = false;
            }
        });

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        closeModalBtn.addEventListener('click', () => {
            progressModal.style.display = 'none';
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', (event) => {
            if (event.target === progressModal) {
                progressModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>

