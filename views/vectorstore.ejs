<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²¡í„°ìŠ¤í† ì–´ ë§Œë“¤ê¸°</title>
    <link rel="stylesheet" href="/css/home.css">
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div>
                <h2>íŒŒì¼ ê´€ë¦¬</h2>
                <p>File Manager</p>
                <button class="btn" onclick="window.location.href='/file_manager'">ğŸ“ íŒŒì¼ ê´€ë¦¬</button>
                <button class="btn" onclick="window.location.href='/file_upload'">ğŸ“„ íŒŒì¼ì—…ë¡œë“œ</button>
                <button class="btn" onclick="window.location.href='/folder_upload'">ğŸ“ í´ë” ì—…ë¡œë“œ</button>
                <button class="btn" onclick="window.location.href='/vectorstore'">ğŸ” ë²¡í„°ìŠ¤í† ì–´ ë§Œë“¤ê¸°</button>
                <button class="btn" onclick="window.location.href='/file_search'">ğŸ“š ë¬¸ì„œë‚´ìš© ê²€ìƒ‰</button>
            </div>
            <div>
                <button class="btn" onclick="window.location.href='/'">â† í™ˆìœ¼ë¡œ</button>
            </div>
        </div>

        <!-- ë©”ì¸ -->
        <div class="main">
            <div class="summary">
                <h2>ğŸ” ë²¡í„°ìŠ¤í† ì–´ ë§Œë“¤ê¸°</h2>
                
                <!-- ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì„¹ì…˜ -->
                <div class="summary-box">
                    <h3>DBì— ì €ì¥ëœ ë‚´ìš© ë²¡í„°ìŠ¤í† ì–´ ìƒì„±:</h3>
                    <button id="createVectorStoreBtn" class="btn" style="margin-top: 15px;">ë²¡í„° ìŠ¤í† ì–´ ìƒì„±</button>
                    <div id="resultMessage" style="margin-top: 15px;"></div>
                </div>

                <!-- ë²¡í„°ìŠ¤í† ì–´ ê²€ìƒ‰ ì„¹ì…˜ -->
                <div class="summary-box">
                    <h3>ë²¡í„°ìŠ¤í† ì–´ì—ì„œ ê²€ìƒ‰:</h3>
                    <div style="display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px;">
                        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="search-input">
                        <button id="searchBtn" class="btn" style="padding: 14px 32px; font-size: 16px; font-weight: 600;">ğŸ” ê²€ìƒ‰</button>
                    </div>
                    <div id="searchResults" style="margin-top: 15px;">
                        <p style="text-align: center; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- ìƒì„±ëœ ë²¡í„°ìŠ¤í† ì–´ ëª©ë¡ -->
                <div class="summary-box">
                    <h3>ìƒì„±ëœ ë²¡í„°ìŠ¤í† ì–´ ëª©ë¡:</h3>
                    <div id="vectorstoreList" class="file-list" style="margin-top: 15px;">
                        <table class="file-table">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">ìˆœë²ˆ</th>
                                    <th>í´ë”ëª…</th>
                                    <th>ë¬¸ì„œìˆ˜ëŸ‰</th>
                                    <th>ìƒì„±ë‚ ì§œ</th>
                                    <th>ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody id="vectorstoreTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #666; padding: 15px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì§„í–‰ ëª¨ë‹¬ -->
    <div id="progressModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘...</h3>
            <div id="progressStatus" style="margin: 20px 0;">
                <p id="statusText">ì´ˆê¸°í™” ì¤‘...</p>
            </div>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="finalResult" style="margin-top: 20px; display: none;">
                <p id="resultText" style="font-size: 18px; font-weight: bold;"></p>
            </div>
            <button id="closeModalBtn" class="upload-btn" style="margin-top: 20px; display: none;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const createVectorStoreBtn = document.getElementById('createVectorStoreBtn');
        const progressModal = document.getElementById('progressModal');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const finalResult = document.getElementById('finalResult');
        const resultText = document.getElementById('resultText');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const resultMessage = document.getElementById('resultMessage');
        const vectorstoreTableBody = document.getElementById('vectorstoreTableBody');

        // ë²¡í„°ìŠ¤í† ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadVectorStoreList() {
            try {
                const response = await fetch('/api/vectorstore-list');
                const data = await response.json();
                
                if (data.success && data.folders.length > 0) {
                    // ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    window.vectorstoreData = data.folders;
                    
                    const rowsHTML = data.folders.map((folder, index) => {
                        const displayId = index === 0 
                            ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">ìµœì‹ </span>`
                            : folder.id;
                        
                        // ì²« ë²ˆì§¸ í–‰(ìµœì‹ )ì€ ìš´ì˜ì¤‘ ë²„íŠ¼, ë‚˜ë¨¸ì§€ëŠ” ì‚­ì œ ë²„íŠ¼
                        const buttonHtml = index === 0
                            ? `<button onclick="alert('í˜„ì¬ ìš´ì˜ì¤‘ì¸ ë²¡í„°ìŠ¤í† ì–´ ì…ë‹ˆë‹¤.'); return false;" style="padding: 8px 16px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 4px rgba(17, 153, 142, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(17, 153, 142, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(17, 153, 142, 0.3)';">
                                    âœ… ìš´ì˜ì¤‘
                                </button>`
                            : `<button onclick="deleteVectorStore(${folder.id})" style="padding: 8px 16px; background: #f5576c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#e0485c'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='#f5576c'; this.style.transform='translateY(0)';">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>`;
                        
                        return `
                        <tr data-index="${index}" data-folder-id="${folder.id}">
                            <td style="text-align: center; font-weight: 600; color: #6a4c93;">${displayId}</td>
                            <td>${folder.name}</td>
                            <td>${folder.fileCount}ê°œ</td>
                            <td>${folder.date}</td>
                            <td style="text-align: center;">
                                ${buttonHtml}
                            </td>
                        </tr>
                        `;
                    }).join('');
                    vectorstoreTableBody.innerHTML = rowsHTML;
                    
                    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    vectorstoreTableBody.querySelectorAll('tr').forEach(row => {
                        row.addEventListener('click', function(e) {
                            // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” í–‰ ì„ íƒ ë™ì‘ ì•ˆ í•¨
                            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                                return;
                            }
                            
                            // ì´ì „ ì„ íƒ ì œê±°
                            vectorstoreTableBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                            // í˜„ì¬ í–‰ ì„ íƒ
                            this.classList.add('selected');
                        });
                    });
                    
                    // ì²« ë²ˆì§¸ í–‰(ìµœì‹ ) ìë™ ì„ íƒ
                    const firstRow = vectorstoreTableBody.querySelector('tr');
                    if (firstRow) {
                        firstRow.classList.add('selected');
                    }
                } else {
                    vectorstoreTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">ìƒì„±ëœ ë²¡í„°ìŠ¤í† ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading vectorstore list:', error);
                vectorstoreTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // ë²¡í„°ìŠ¤í† ì–´ ì‚­ì œ í•¨ìˆ˜ (ì „ì—­ìœ¼ë¡œ ë“±ë¡)
        window.deleteVectorStore = async function(folderId) {
            const folderName = window.vectorstoreData?.find(f => f.id === folderId)?.name || '';
            
            // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
            const confirmed = confirm(`ì •ë§ë¡œ "${folderName}" ë²¡í„°ìŠ¤í† ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-vectorstore/${folderId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ë²¡í„°ìŠ¤í† ì–´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadVectorStoreList();
                } else {
                    alert('âŒ ë²¡í„°ìŠ¤í† ì–´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ë²¡í„°ìŠ¤í† ì–´ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadVectorStoreList();

        // ì§„í–‰ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            statusText.textContent = text;
        }

        // Python ì¶œë ¥ íŒŒì‹±í•˜ì—¬ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function parseProgress(output) {
            const lines = output.split('\n');
            
            for (let line of lines) {
                if (line.includes('MySQL ì—°ê²° ì„±ê³µ')) {
                    updateProgress(10, 'MySQL ì—°ê²° ì„±ê³µ');
                } else if (line.includes('ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ')) {
                    // ë¬¸ì„œ ê°œìˆ˜ ì¶”ì¶œ
                    const match = line.match(/(\d+)ê°œ ë¬¸ì„œ/);
                    if (match) {
                        updateProgress(25, `${match[1]}ê°œ ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ`);
                    }
                } else if (line.includes('ì²­í‚¹ ì™„ë£Œ')) {
                    updateProgress(40, 'ë¬¸ì„œ ì²­í‚¹ ì™„ë£Œ');
                } else if (line.includes('ì„ë² ë”© ëª¨ë¸ ì„¤ì • ì™„ë£Œ')) {
                    updateProgress(60, 'ì„ë² ë”© ëª¨ë¸ ì„¤ì • ì™„ë£Œ');
                } else if (line.includes('ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘')) {
                    updateProgress(80, 'ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘...');
                } else if (line.includes('ë²¡í„°ìŠ¤í† ì–´ êµ¬ì¶• ì™„ë£Œ')) {
                    updateProgress(100, 'ì™„ë£Œ!');
                }
            }
        }

        // ë¬¸ì„œ ê°œìˆ˜ ì¶”ì¶œ
        function extractDocumentCount(output) {
            const match = output.match(/MySQLì—ì„œ (\d+)ê°œ ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ/);
            return match ? match[1] : null;
        }

        // ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        createVectorStoreBtn.addEventListener('click', async () => {
            // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
            const confirmed = confirm('ë²¡í„°ìŠ¤í† ì–´ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!confirmed) {
                return;
            }

            // ëª¨ë‹¬ ì—´ê¸°
            progressModal.style.display = 'flex';
            statusText.textContent = 'ë²¡í„°ìŠ¤í† ì–´ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            finalResult.style.display = 'none';
            closeModalBtn.style.display = 'none';
            createVectorStoreBtn.disabled = true;

            // ì´ˆê¸° ì§„í–‰ë¥  í‘œì‹œ
            updateProgress(5, 'ë²¡í„°ìŠ¤í† ì–´ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...');

            try {
                // API í˜¸ì¶œ ì‹œì‘ - ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                updateProgress(10, 'ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ì¤‘...');
                
                const response = await fetch('/api/create-vectorstore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // ì‘ë‹µ ëŒ€ê¸° ì¤‘ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                updateProgress(20, 'ì„œë²„ì—ì„œ ì²˜ë¦¬ ì¤‘...');

                const data = await response.json();

                if (data.success) {
                    // ì§„í–‰ë°” ì—…ë°ì´íŠ¸ - ë‹¨ê³„ë³„ë¡œ í‘œì‹œ
                    const output = data.output || '';
                    
                    // ì¶œë ¥ì´ ìˆìœ¼ë©´ ë‹¨ê³„ë³„ ì§„í–‰ë¥  í‘œì‹œ
                    if (output) {
                        const lines = output.split('\n');
                        let foundProgress = 20;
                        let foundMessage = 'ì²˜ë¦¬ ì¤‘...';
                        
                        // ì¶œë ¥ì—ì„œ ê° ë‹¨ê³„ë¥¼ ì°¾ì•„ì„œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ìˆœì„œëŒ€ë¡œ)
                        for (let line of lines) {
                            if (line.includes('MySQL ì—°ê²° ì„±ê³µ')) {
                                foundProgress = 15;
                                foundMessage = 'MySQL ì—°ê²° ì„±ê³µ';
                            } else if (line.includes('ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ')) {
                                const match = line.match(/(\d+)ê°œ ë¬¸ì„œ/);
                                if (match) {
                                    foundProgress = 30;
                                    foundMessage = `${match[1]}ê°œ ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ`;
                                }
                            } else if (line.includes('ì²­í‚¹ ì™„ë£Œ')) {
                                foundProgress = 50;
                                foundMessage = 'ë¬¸ì„œ ì²­í‚¹ ì™„ë£Œ';
                            } else if (line.includes('ì„ë² ë”© ëª¨ë¸ ì„¤ì • ì™„ë£Œ')) {
                                foundProgress = 70;
                                foundMessage = 'ì„ë² ë”© ëª¨ë¸ ì„¤ì • ì™„ë£Œ';
                            } else if (line.includes('ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘')) {
                                foundProgress = 85;
                                foundMessage = 'ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì¤‘...';
                            } else if (line.includes('ë²¡í„°ìŠ¤í† ì–´ êµ¬ì¶• ì™„ë£Œ')) {
                                foundProgress = 100;
                                foundMessage = 'ë²¡í„°ìŠ¤í† ì–´ êµ¬ì¶• ì™„ë£Œ!';
                                break; // ì™„ë£Œë˜ë©´ ë£¨í”„ ì¢…ë£Œ
                            }
                        }
                        
                        // ìµœì¢… ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                        updateProgress(foundProgress, foundMessage);
                        
                        // ì™„ë£Œê°€ ì•„ë‹ˆë©´ 100%ë¡œ ì„¤ì •
                        if (foundProgress < 100) {
                            setTimeout(() => {
                                updateProgress(100, 'ì™„ë£Œ!');
                            }, 200);
                        }
                    } else {
                        // ì¶œë ¥ì´ ì—†ìœ¼ë©´ ì™„ë£Œë¡œ í‘œì‹œ
                        updateProgress(100, 'ì™„ë£Œ!');
                    }
                    
                    // ì™„ë£Œ ë©”ì‹œì§€
                    setTimeout(() => {
                        const docCount = extractDocumentCount(output);
                        if (docCount) {
                            finalResult.style.display = 'block';
                            resultText.textContent = `âœ… ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ! (${docCount}ê°œ ë¬¸ì„œ)`;
                            resultText.style.color = 'green';
                        } else {
                            finalResult.style.display = 'block';
                            resultText.textContent = 'âœ… ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ!';
                            resultText.style.color = 'green';
                        }
                        closeModalBtn.style.display = 'block';
                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadVectorStoreList();
                    }, 500);
                } else {
                    updateProgress(0, 'ì˜¤ë¥˜ ë°œìƒ');
                    finalResult.style.display = 'block';
                    resultText.textContent = 'âŒ ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    resultText.style.color = 'red';
                    closeModalBtn.style.display = 'block';
                }
            } catch (error) {
                updateProgress(0, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                finalResult.style.display = 'block';
                resultText.textContent = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message;
                resultText.style.color = 'red';
                closeModalBtn.style.display = 'block';
            } finally {
                createVectorStoreBtn.disabled = false;
            }
        });

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        closeModalBtn.addEventListener('click', () => {
            progressModal.style.display = 'none';
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', (event) => {
            if (event.target === progressModal) {
                progressModal.style.display = 'none';
            }
        });

        // ë²¡í„°ìŠ¤í† ì–´ ê²€ìƒ‰ ê¸°ëŠ¥
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        let selectedVectorstoreId = null;

        // ë²¡í„°ìŠ¤í† ì–´ ì„ íƒ ì´ë²¤íŠ¸
        document.addEventListener('click', function(e) {
            const row = e.target.closest('tr');
            if (row && e.target.tagName !== 'BUTTON') {
                // ì´ì „ ì„ íƒ ì œê±°
                vectorstoreTableBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                // í˜„ì¬ í–‰ ì„ íƒ
                row.classList.add('selected');
                
                const folderId = row.getAttribute('data-folder-id');
                selectedVectorstoreId = folderId;
                console.log('ì„ íƒëœ ë²¡í„°ìŠ¤í† ì–´ ID:', selectedVectorstoreId);
                
                // ì„ íƒëœ ë²¡í„°ìŠ¤í† ì–´ í‘œì‹œ
                const selectedVectorstoreInfo = window.vectorstoreData?.find(f => f.id === folderId);
                if (selectedVectorstoreInfo) {
                    console.log(`âœ… ê²€ìƒ‰ì— ì‚¬ìš©ë  ë²¡í„°ìŠ¤í† ì–´: ${selectedVectorstoreInfo.name} (${selectedVectorstoreInfo.fileCount}ê°œ ë¬¸ì„œ)`);
                }
            }
        });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        searchBtn.addEventListener('click', async function() {
            const query = searchInput.value.trim();
            
            if (!query) {
                searchResults.innerHTML = '<div style="padding: 15px; border-radius: 6px; background: linear-gradient(135deg, #f8e0e0 0%, #f5c8c8 100%); color: #842029; border-left: 3px solid #dc3545;">âŒ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            searchBtn.disabled = true;
            searchResults.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6a4c93; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 10px; color: #666;">ê²€ìƒ‰ ì¤‘...</p></div>';

            try {
                const response = await fetch('/api/search-vectorstore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query, vectorstoreId: selectedVectorstoreId })
                });

                const data = await response.json();
                
                if (data.success && data.results && data.results.length > 0) {
                    // ê²€ìƒ‰ ì •ë³´ í‘œì‹œ
                    const selectedInfo = selectedVectorstoreId 
                        ? window.vectorstoreData?.find(f => f.id === selectedVectorstoreId)
                        : window.vectorstoreData?.[0];
                    
                    let resultsHTML = `
                        <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 600;">ğŸ” ê²€ìƒ‰ì–´: "${query}"</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                                ğŸ“¦ ì‚¬ìš©ëœ ë²¡í„°ìŠ¤í† ì–´: ${selectedInfo ? `${selectedInfo.name} (${selectedInfo.fileCount}ê°œ ë¬¸ì„œ)` : 'ìµœì‹  ë²¡í„°ìŠ¤í† ì–´'}
                            </div>
                        </div>
                    `;
                    resultsHTML += '<div style="margin-top: 20px;">';
                    data.results.forEach(item => {
                        const medal = item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : item.rank === 3 ? 'ğŸ¥‰' : 'ğŸ…';
                        const relevanceColor = item.relevance >= 80 ? '#10b981' : item.relevance >= 50 ? '#f59e0b' : '#ef4444';
                        resultsHTML += `
                            <div style="margin-bottom: 20px; padding: 20px; background: #ffffffcc; border-radius: 8px; border-left: 4px solid #6a4c93;">
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <div style="font-size: 36px; flex-shrink: 0;">${medal}</div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                                            <div style="font-size: 18px; font-weight: 600; color: #6a4c93;">
                                                ê²€ìƒ‰ë¦¬ìŠ¤íŠ¸ ${item.rank} - ${item.file_name}
                                            </div>
                                            <div style="padding: 6px 16px; background: ${relevanceColor}; color: white; border-radius: 20px; font-weight: 700; font-size: 16px; box-shadow: 0 2px 8px ${relevanceColor}66;">
                                                ${item.relevance}% ìœ ì‚¬ë„
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <span style="font-size: 14px; color: #666; padding: 6px 12px; background: rgba(106, 76, 147, 0.1); border-radius: 4px;">ğŸ“ ${item.file_location}</span>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: #333;">ğŸ“ ìš”ì•½:</strong>
                                            <div style="padding: 12px; background: rgba(106, 76, 147, 0.05); border-radius: 6px; margin-top: 6px;">
                                                ${item.summary}
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: #333;">ğŸ—ï¸ í‚¤ì›Œë“œ:</strong>
                                            <div style="padding: 12px; background: rgba(106, 76, 147, 0.05); border-radius: 6px; margin-top: 6px;">
                                                ${item.keywords}
                                            </div>
                                        </div>
                                        <div>
                                            <strong style="color: #333;">ğŸ“„ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:</strong>
                                            <div style="padding: 12px; background: rgba(106, 76, 147, 0.05); border-radius: 6px; margin-top: 6px; white-space: pre-wrap; word-break: break-word;">
                                                ${item.content_preview}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    resultsHTML += '</div>';
                    searchResults.innerHTML = resultsHTML;
                } else if (data.ollamaError) {
                    searchResults.innerHTML = `
                        <div style="padding: 30px; border-radius: 12px; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); color: #856404; border-left: 5px solid #ffc107; text-align: center; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);">
                            <div style="font-size: 64px; margin-bottom: 20px;">âš ï¸</div>
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #856404;">
                                Ollama ì„œë²„ê°€ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤
                            </div>
                            <div style="font-size: 17px; margin-bottom: 20px; color: #856404;">
                                Ollama ì„œë²„ë¥¼ ì‹¤í–‰í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                            </div>
                            <div style="font-size: 15px; color: #856404; opacity: 0.9; line-height: 1.8;">
                                <strong>ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ Ollama ì„œë²„ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:</strong><br>
                                <code style="background: rgba(0,0,0,0.1); padding: 10px 16px; border-radius: 6px; font-family: 'Courier New', monospace; display: inline-block; margin-top: 12px; font-size: 16px; color: #856404;">ollama serve & ollama pull exaone3.5:2.4b</code>
                            </div>
                        </div>
                    `;
                } else {
                    searchResults.innerHTML = `
                        <div style="padding: 15px; border-radius: 6px; background: linear-gradient(135deg, #f8e0e0 0%, #f5c8c8 100%); color: #842029; border-left: 3px solid #dc3545;">
                            âŒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                searchResults.innerHTML = `
                    <div style="padding: 15px; border-radius: 6px; background: linear-gradient(135deg, #f8e0e0 0%, #f5c8c8 100%); color: #842029; border-left: 3px solid #dc3545;">
                        âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
            }
        });

        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

